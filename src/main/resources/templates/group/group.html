<!DOCTYPE HTML>
<html xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml"
    layout:decorate="~{layouts/base}" lang="en">


<!-- page style -->
<th:block layout:fragment="style" th:remove="tag"></th:block>


<!-- page title -->
<th:block layout:fragment="title" th:remove="tag">Group</th:block>


<!-- The 'body' section is defined using Thymeleaf's layout fragment. It will replace the 'body' content in the base layout -->
<th:block layout:fragment="body" th:remove="tag">
    <div class="container mt-4">
        <h2 class="mb-4">Group Management</h2>


        <!-- Admin Import/Export Buttons -->
        <div class="mb-3" sec:authorize="hasAuthority('ROLE_ADMIN')">
            <button id="export-all-groups" class="btn btn-secondary btn-sm">Export Groups</button>
            <!-- TODO: Re-enable Import Functionality -->
            <!-- <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                Import Groups
            </button> -->
        </div>
        <!-- Search bar -->
        <input type="text" id="searchInput" class="form-control mb-3"
            placeholder="Search by Group ID or Member Name/Email">


        <!-- Table -->
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Group ID</th>
                    <th>Name</th>
                    <th>Period</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="groupTableBody" th:each="group : ${groups}">
                <tr class="group-row" th:data-groupid="${group.id}">
                    <td th:text="${group.id}"></td>
                    <td th:text="${group.name}"></td>
                    <td th:text="${group.period}"></td>
                    <td>
                        <button class="btn btn-sm btn-primary toggle-members"
                                data-bs-toggle="collapse"
                                th:data-bs-target="'#members-' + ${group.id}">
                            View Members
                        </button>
                        <button class="btn btn-sm btn-warning add-user-to-group"
                                th:data-groupid="${group.id}"
                                th:data-name="${group.name}"
                                th:data-period="${group.period}">
                            Add Group Member
                        </button>
                        <button class="btn btn-sm btn-danger delete-group"
                                th:data-groupid="${group.id}"
                                onclick="return confirm('Are you sure you want to delete this group?')">
                            Delete
                        </button>
                    </td>
                </tr>


                <tr class="collapse" th:id="'members-' + ${group.id}">
                    <td colspan="4">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>UID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="member : ${group.groupMembers}">
                                    <td th:text="${member.uid}"></td>
                                    <td th:text="${member.name}"></td>
                                    <td><a th:href="'mailto:' + ${member.email}" th:text="${member.email}"></a></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger remove-user-from-group"
                                                th:data-groupid="${group.id}"
                                                th:data-personid="${member.id}">
                                            Remove from Group
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>


        </table>
    </div>
    <!-- Create Group Button -->
    <div class="d-flex justify-content-center mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createGroupModal">
            Create Group
        </button>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="color: #212529; background-color: #fff;">
                <div class="modal-header">
                    <h5 class="modal-title" id="createGroupModalLabel">Create Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>


                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupNameInput" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupNameInput" placeholder="Enter group name">
                    </div>


                    <div class="mb-3">
                        <label for="groupPeriodInput" class="form-label">Group Period</label>
                        <input type="text" class="form-control" id="groupPeriodInput" placeholder="Enter group period">
                    </div>

                </div>


                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="createGroupBtn">Create Group</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="color: #212529; background-color: #fff;">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">Add Group Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">Add a user to <strong id="addMemberGroupName"></strong>.</p>
                    <input type="hidden" id="addMemberGroupId">
                    <div class="mb-3">
                        <label for="userSearchInput" class="form-label">Search User</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="userSearchInput" placeholder="Enter name or email">
                            <button class="btn btn-outline-secondary" type="button" id="userSearchBtn">Search</button>
                        </div>
                    </div>
                    <div id="userSearchResults" class="list-group" style="max-height: 200px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                    <input type="hidden" id="selectedUserId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmAddMemberBtn">Add Member</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Edit Group Modal -->
    <div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="color: #212529; background-color: #fff;">
                <div class="modal-header">
                    <h5 class="modal-title" id="editGroupModalLabel">Edit Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>


                <div class="modal-body">
                    <input type="hidden" id="editGroupId">
                    <div class="mb-3">
                        <label for="editGroupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="editGroupName">
                    </div>
                    <div class="mb-3">
                        <label for="editGroupPeriod" class="form-label">Group Period</label>
                        <input type="text" class="form-control" id="editGroupPeriod">
                    </div>


                    <div id="editUserContainer"
                        style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 0.375rem;">
                        <div class="mb-3">
                            <input type="text" id="userSearchEdit" class="form-control" placeholder="Search users...">
                        </div>
                        <div id="editUserList" class="row"></div>
                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="saveEditBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


        <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="color: #212529; background-color: #fff;">
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Groups</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="importForm">
                        <div class="mb-3">
                            <label for="importFile" class="form-label">Select File</label>
                            <input type="file" class="form-control" id="importFile" name="file" accept=".json">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="importBtn">Import</button>
                </div>
            </div>
        </div>
    </div>


</th:block>
<th:block layout:fragment="script" th:remove="tag">
    <script>
        // setup
        // Removed javaURI and absolute URL logic; use relative URLs instead

        const javaURL = "/api/groups";
        const personURL = "/api/people"; // Use relative URL for user API endpoint

        // get table
        const $tableBody = $("#groupTableBody");

        // Add-member modal helpers
        const addMemberModal = new bootstrap.Modal(document.getElementById("addMemberModal"));
        const addMemberGroupName = document.getElementById("addMemberGroupName");
        const addMemberGroupId = document.getElementById("addMemberGroupId");
        const selectedUserId = document.getElementById("selectedUserId");

        // Search for users to add to a group
        document.getElementById("userSearchBtn").addEventListener("click", function() {
            const searchTerm = document.getElementById("userSearchInput").value;
            if (!searchTerm) {
                return;
            }

            fetch(`${personURL}/search?query=${encodeURIComponent(searchTerm)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("User search failed");
                    }
                    return response.json();
                })
                .then(users => {
                    const searchResults = document.getElementById("userSearchResults");
                    searchResults.innerHTML = ""; // Clear previous results
                    users.forEach(user => {
                        const userElement = document.createElement("a");
                        userElement.href = "#";
                        userElement.classList.add("list-group-item", "list-group-item-action");
                        userElement.textContent = `${user.name} (${user.email})`;
                        userElement.dataset.userId = user.id;
                        userElement.addEventListener("click", function(e) {
                            e.preventDefault();
                            selectedUserId.value = this.dataset.userId;
                            // Highlight selection
                            Array.from(searchResults.children).forEach(child => child.classList.remove("active"));
                            this.classList.add("active");
                        });
                        searchResults.appendChild(userElement);
                    });
                })
                .catch(error => {
                    console.error("Error searching for users:", error);
                    alert("Failed to search for users. See console for details.");
                });
        });

        // Filter groups
        $("#searchInput").on("keyup", function () {
            const search = $(this).val().toLowerCase();
            $("#groupTableBody tr.group-row").each(function () {
                const groupId = ($(this).data("groupid") ?? "").toString();
                const members = ($(this).data("members") ?? "").toString();
                const match = groupId.includes(search) || members.includes(search);
                $(this).toggle(match);

                const memberDetails = $(`#members-${groupId}`);
                memberDetails.toggle(match);

                // Reset the style when search is cleared
                if (search === "") {
                    memberDetails.attr("style", "");
                }
            });
        });

        // Open add-member modal
        $(document).on("click", ".add-user-to-group", function () {
            const groupId = $(this).data("groupid");
            const groupName = $(this).data("name") || groupId;

            addMemberGroupName.textContent = groupName;
            addMemberGroupId.value = groupId;
            selectedUserId.value = ""; // Clear previous selection
            document.getElementById("userSearchInput").value = ""; // Clear search input
            document.getElementById("userSearchResults").innerHTML = ""; // Clear search results


            addMemberModal.show();
        });

        // Confirm add member
        document.getElementById("confirmAddMemberBtn").addEventListener("click", function () {
            const groupId = addMemberGroupId.value;
            const userId = selectedUserId.value;

            if (!userId) {
                alert("Please enter a user to add.");
                return;
            }

            fetch(`${javaURL}/${groupId}/members/${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to add member to group");
                return response;
            })
            .then(() => {
                alert("User added to group!");
                addMemberModal.hide();
                location.reload();
            })
            .catch(error => {
                console.error("Error adding member:", error);
                alert("Failed to add member. See console for details.");
            });
        });

        document.getElementById("importBtn").addEventListener("click", async () => {
            const fileInput = document.getElementById("importFile");
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a file to import.");
                return;
            }

            try {
                const text = await file.text();
                const json = JSON.parse(text);

                if (!Array.isArray(json)) {
                    alert("Import file must be a JSON array.");
                    return;
                }

                const response = await fetch("/api/groups/bulk/create", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(json),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP error ${response.status}`);
                }

                const result = await response.json();

                let msg = "";
                if (result.created?.length) msg += `Created: ${result.created.join(", ")}.\n`;
                if (result.duplicates?.length) msg += `Duplicates: ${result.duplicates.join(", ")}.\n`;
                if (result.errors?.length) msg += `Errors: ${result.errors.join(", ")}.\n`;

                alert(msg || "Groups imported successfully!");

                fileInput.value = "";
                var importModal = bootstrap.Modal.getInstance(document.getElementById("importModal"));
                importModal.hide();
                location.reload();

            } catch (error) {
                console.error("Import error:", error);
                alert("An error occurred during import: " + error.message);
            }
        });

        // Populate user list in modal
        function fetchUsers() {
            fetch(personURL)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(users => {
                    const userList = document.getElementById("createUserList");
                    if (!userList) return; // Guard when create list is absent on page
                    userList.innerHTML = "";

                    users.forEach(user => {
                        const div = document.createElement("div");
                        div.course = "col-md-6";
                        div.innerHTML = `
                            <div class="form-check mb-2">
                                <input class="form-check-input user-checkbox" type="checkbox" value="${user.id}" id="user-${user.id}">
                                <label class="form-check-label" for="user-${user.id}">
                                    ${user.name} (${user.email})
                                </label>
                            </div>
                        `;
                        userList.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error("Error loading users:", error);
                });
        }

        // Open modal and load users
        $('#createGroupModal').on('show.bs.modal', function () {
            fetchUsers();
        });

        // Create group handler
        document.getElementById("createGroupBtn").addEventListener("click", function () {
            const groupName = document.getElementById("groupNameInput").value;
            const groupPeriod = document.getElementById("groupPeriodInput").value;

            if (!groupName || groupName.trim() === "") {
                alert("Please enter a group name.");
                return;
            }

            // Create group with name and period only
            fetch(javaURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: groupName,
                    period: groupPeriod
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to create group");
                return response.json();
            })
            .then(() => {
                alert("Group created successfully!");
                $('#createGroupModal').modal('hide');
                location.reload();
            })
            .catch(error => {
                console.error("Error creating group:", error);
                alert("An error occurred. See console.");
            });
        });

        // Open edit modal and pre-fill
        $(document).on("click", ".edit-group", function () {
            const groupId = $(this).data("groupid");
            const name = $(this).data("name");
            const period = $(this).data("period");

            document.getElementById("editGroupId").value = groupId;
            document.getElementById("editGroupName").value = name;
            document.getElementById("editGroupPeriod").value = period;

            // Load users and precheck current members
            Promise.all([
                fetch(`${javaURL}/${groupId}`).then(resp => {
                    if (!resp.ok) throw new Error("Failed to fetch group");
                    return resp.json();
                }),
                fetch(personURL).then(resp => {
                    if (!resp.ok) throw new Error("Failed to fetch users");
                    return resp.json();
                })
            ])
            .then(([groupData, allUsers]) => {
                const editUserList = document.getElementById("editUserList");
                editUserList.innerHTML = "";

                const memberIds = groupData.members.map(m => m.uid);

                allUsers.forEach(user => {
                    const div = document.createElement("div");
                    div.course = "col-md-6";
                    div.innerHTML = `
                        <div class="form-check mb-2">
                            <input class="form-check-input edit-user-checkbox" type="checkbox" value="${user.id}" id="edit-user-${user.id}" ${memberIds.includes(user.uid) ? "checked" : ""}>
                            <label class="form-check-label" for="edit-user-${user.id}">
                                ${user.name} (${user.email})
                            </label>
                        </div>
                    `;
                    editUserList.appendChild(div);
                });

                $('#editGroupModal').modal('show');
            })
            .catch(error => {
                console.error("Failed to load users or group:", error);
                alert("Error loading group data.");
            });
        });

        // Save edit
        document.getElementById("saveEditBtn").addEventListener("click", function () {
            const groupId = document.getElementById("editGroupId").value;
            const newName = document.getElementById("editGroupName").value;
            const newPeriod = document.getElementById("editGroupPeriod").value;
            const newUserIds = Array.from(document.querySelectorAll('.edit-user-checkbox:checked')).map(cb => parseInt(cb.value));

            // 1. Get current group members
            fetch(`${javaURL}/${groupId}`)
            .then(resp => {
                if (!resp.ok) throw new Error("Failed to fetch group");
                return resp.json();
            })
            .then(group => {
                const currentIds = group.members.map(m => m.id);

                const toRemove = currentIds.filter(id => !newUserIds.includes(id));
                const toAdd = newUserIds.filter(id => !currentIds.includes(id));

                // 2. Update name/period
                return fetch(`${javaURL}/${groupId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newName, period: newPeriod })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to update group");
                    // 3. Remove users if any
                    if (toRemove.length > 0) {
                        return fetch(`${javaURL}/${groupId}/removePeople`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(toRemove)
                        })
                    }
                })
                .then(() => {
                    // Add users if any
                    if (toAdd.length > 0) {
                        return fetch(`${javaURL}/${groupId}/addPeople`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(toAdd)
                        })
                        .then(resp => {
                            if (!resp.ok) throw new Error("Failed to add people");
                        });
                    }
                })
                .then(() => {
                    alert("Group updated!");
                    $('#editGroupModal').modal('hide');
                    location.reload();
                });
            })
            .catch(error => {
                console.error("Error saving edits:", error);
                alert("Failed to save changes.");
            });
        });

        document.getElementById("userSearchEdit").addEventListener("input", function () {
            const searchTerm = this.value.toLowerCase();
            const checkboxes = document.querySelectorAll("#editUserList .form-check-label");

            checkboxes.forEach(label => {
                const userText = label.textContent.toLowerCase();
                const container = label.closest(".col-md-6");
                container.style.display = userText.includes(searchTerm) ? "" : "none";
            });
        });

        const userSearchCreate = document.getElementById("userSearchCreate");
        if (userSearchCreate) {
            userSearchCreate.addEventListener("input", function () {
                const searchTerm = this.value.toLowerCase();
                const checkboxes = document.querySelectorAll("#createUserList .form-check-label");

                checkboxes.forEach(label => {
                    const userText = label.textContent.toLowerCase();
                    const container = label.closest(".col-md-6");
                    container.style.display = userText.includes(searchTerm) ? "" : "none";
                });
            });
        }

        // Delete group handler
        $(document).on("click", ".delete-group", function () {
            const groupId = $(this).data("groupid");
            
            fetch(`${javaURL}/${groupId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to delete group");
                return response.json();
            })
            .then(() => {
                alert("Group deleted successfully!");
                location.reload();
            })
            .catch(error => {
                console.error("Error deleting group:", error);
                alert("Failed to delete group. See console.");
            });
        });

        // Remove member handler
        $(document).on("click", ".remove-user-from-group", function () {
            const groupId = $(this).data("groupid");
            const personId = $(this).data("personid");

            fetch(`${javaURL}/${groupId}/members/${personId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to remove member from group");
                return response;
            })
            .then(() => {
                alert("Member removed from group.");
                location.reload();
            })
            .catch(error => {
                console.error("Error removing member:", error);
                alert("Failed to remove member. See console.");
            });
        });
    </script>
    <script sec:authorize="hasRole('ROLE_ADMIN')" type="module" src="/static/js/group-extraction.js"
        th:src="@{/js/group-extraction.js}"></script>
</th:block>


</html>
